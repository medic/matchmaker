<!DOCTYPE html> 
<html>
<head>
	<!-- SITE INFO -->
	<meta charset="utf-8">
	<title>CONSTRAINTS /mm</title>
	<meta name="description" content="Hello thar">
	<!-- END SITE INFO -->
	
	<!-- STYLE SHEETS -->
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="bootstrap.min.css">
	<link rel="stylesheet" href="jquery.dropdown.css" />
	<!-- END STYLE SHEETS -->
   
	<!-- JAVASCRIPT -->	
	<script src="js/jquery-1.10.2.min.js"></script>
	<script src="bootstrap.min.js"></script>
	<script src="jquery.dropdown.js"></script>
	<script src="jquery.listen-1.0.3-min.js"></script>
	<!-- END JAVASCRIPT -->
	
	<script>
		// INITIALIZE arrays while document is loading
		var phoneCats,
			compCats,
			allCats,
			constraints,
			tools,
			counter; // number of tools currently available to user
		
		if (!phoneCats) {
			$.getJSON("phoneCats.json", function(data) {
				localStorage.setItem('phoneCats', JSON.stringify(data));	
				phoneCats = JSON.parse(localStorage.getItem('phoneCats'));
			});
		} 
		
		if (!compCats) {
			$.getJSON("compCats.json", function(data) {
				localStorage.setItem('compCats', JSON.stringify(data));	
				compCats = JSON.parse(localStorage.getItem('compCats'));			
			});
		}
		
		if (!allCats) {
			$.getJSON("allCats.json", function(data) {
				localStorage.setItem('allCats', JSON.stringify(data));				
				allCats = JSON.parse(localStorage.getItem('allCats'));
			});
		} 
		
		if (!constraints) {
			$.getJSON("constraints.json", function(data) {
				localStorage.setItem('constraints', JSON.stringify(data));
				constraints = JSON.parse(localStorage.getItem('constraints'));				
			});
		}
		
		if (!tools) {
			$.getJSON("tools.json", function(data) {
				localStorage.setItem('tools', JSON.stringify(data));
				tools = JSON.parse(localStorage.getItem('tools'));
			});
		}
			
		
			
		// ***************************** Page is ready *****************************
		$(window).load(function(){
		
			counter = tools.length;
			$("small#counter").text("(" + counter +")");
			
			noConstraintsSel();
			loadTools();
			checkMsgType(); // default behavior of categories on load
			
			
			// ADDING & REMOVING constraints
			$.listen('click', 'img.constraintImg', function() {	
		
				var parent = $(this).parent();
				
				// Add the constraint if the image clicked is inside a category pane
				if (($(parent).attr('id')).match(/[a-zA-Z]+Constraints$/) != null) {			
				
					var attr = $(this).attr('id');
				
					// But don't add it more than once
					if ($("section#userselected").has("img#" + attr + "Sel").length == 0) {
						$("p#noSelect").remove();
						$("section#userselected").append($(this).clone(true).attr("id", attr + "Sel"));
						//$("section#userselected").append('<button class="close x">&times;</button>');					
					}

					updateTools(attr, parent); // Update list of tech options 		
				}
				
				// Remove the constraint if the image clicked is in the selections pane
				if (($(parent).attr('id')).match(/^userselected$/) != null) {
					
					var attr = $(this).attr('id').replace("Sel", "");
					updateTools(attr, parent); // Update list of tech options first before removing!
					
					$(this).remove();
					noConstraintsSel();
				}	
			});
			
			
			// DROPDOWN behavior
			$("img.drop").click(function() {
				var id = $(this).attr("id");
				if (id == "phoneMsg" || id == "computerMsg" || id == "bothMsg") {
					checkMsgType($(this));
				}
			});
			
			// SHOW/HIDE categories
			var open = false;
			$("section#categories").listen('click', 'p', function() {
				var id = $(this).attr("id");
				var txt = $(this).attr("data-label");
				
				$("p#" + id + "Qs").toggle(200);
				$("section#" + id + "Constraints").toggle(300);
				
				open= !open;
				(open ? $(this).html("&#9660; " + txt) : $(this).html("&#9654; " + txt));
			});


			
			// ***************************** Begin Helper Functions *****************************
			
			
			// argument clickedImage must be a jQuery object
			function checkMsgType(clickedImage) {
				switch ($(clickedImage).attr("id")) {
					case "phoneMsg":
						$("img#selected").attr("src", "img/phone.png");
						$("img#phoneMsg").attr("class", "selected drop");
						$("img#computerMsg").attr("class", "deselected drop");
						$("img#bothMsg").attr("class", "deselected drop");
						loadCategories(phoneCats);
						break;
					case "computerMsg":
						$("img#selected").attr("src", "img/computer.png");
						$("img#computerMsg").attr("class", "selected drop");	
						$("img#phoneMsg").attr("class", "deselected drop");
						$("img#bothMsg").attr("class", "deselected drop");						
						loadCategories(compCats);
						break;
					case "bothMsg": 
						$("img#selected").attr("src", "img/both.png");
						$("img#bothMsg").attr("class", "selected drop");
						$("img#phoneMsg").attr("class", "deselected drop");
						$("img#computerMsg").attr("class", "deselected drop");
						loadCategories(allCats);
						break;
					default:
						var name = $("img#selected").attr("name") + "Cats";
						loadCategories(window[name]);
				}
			}
			
			
			function loadCategories(array) {			
				$("section#categories").empty(); // Wipe the constraints pane
				$("section#categories").append('<h2>Constraints</h2>'); // Add header back in
				
				$.each(array, function(index, data) {			
					// Load the relevant categories
					$("section#categories").append('<p id="' + data.categoryID + '" data-label="' + data.categoryLabel +
						'">&#9654; ' + data.categoryLabel + '</p>');
					$("section#categories").append('<p id="' + data.categoryID + 'Qs" class="helptext">' + data.guidingQs + '</p>');
					$("section#categories").append('<section id="' + data.categoryID + 'Constraints" class="derp"></section>');
					
					$("p#" + data.categoryID + "Qs").hide();
					$("section#" + data.categoryID + "Constraints").hide();				
				});	
				loadConstraints();			
			}
			
			
			function loadConstraints() {
				constraints = JSON.parse(localStorage.getItem('constraints'));
				$.each(constraints, function(index, d){
					$("section#" + d.categoryID + "Constraints").append(
						'<img id="' + d.constraintID + '" src="' + d.imageLink + '" alt="' + d.constraintLabel 
						+ '" class="constraintImg" width="50px" height="80px">'
					);
				});
			}
			
			
			// DEFAULT behavior for zero constraints selected
			function noConstraintsSel() {
				if ($("section#userselected").is(":empty")) {
					$("section#userselected").html('<p id="noSelect">You haven\'t selected anything yet!</p>');
				}
			}

			
			function loadTools() {
				$.each(tools, function(index, d) {
					$("fieldset#tech").append('<p id="' + d.productID + '"><a href="' + d.productLink + '" target="_blank">' + d.productName + '</a></p>');
				});
			}
			
			
			// REFRESH the list of available tools
			function updateTools(attr, parent) {
				
				$.each(tools, function(index, data) {
					if (data[attr] == "false") {
						if (($(parent).attr('id')).match(/[a-zA-Z]+Constraints$/) != null) {
							$("p#" + data.productID).hide();
							counter--;
						} else {
							$("p#" + data.productID).show();
							counter++;
						}
					}
				});	
				
				// Update UI with counter
				$("small#counter").text("(" + counter +")");
			}
			
		});

	</script>
</head>
 
<body class="border">
	<header class="border">
		<nav class="border">
			<ul class="nav">
				<li><a href="http://medicmobile.org" target="_blank">Medic Mobile Home</a> |&nbsp;</li>
				<li><a href="index.html">Toolkit Home</a></li>
				<li id="splitnav"><a href="">View Summary</a></li>
			</ul>
		</nav>
	</header>
	
	<!-- ************ BEGIN PAGE CONTENT ************ -->
	<section class="container">
	
		<!-- BEGIN first content row -->
		<section class="border">
		
			<!-- BEGIN (left side): drop down menu for system messaging type -->
			<section class="aside"><!-- 8711 -->
				<img name="phone" id="selected" src="img/phone.png" width="350px"><button class="close" data-dropdown="#dropdown-1">&#9660;</button> 
			</section>
			
			<!-- BEGIN (right side): title image/headline and user selected constraints-->
			<section class="asideoffset">
				<h1 class="constraints">Medic Mobile Tool Wizard</h1>
			</section>
			
		</section>
		<!-- END first row of content -->
	
		<!-- BEGIN second row of content -->
		<section class="border">
		
			<!-- BEGIN CONSTRAINTS DRAWER (left side) -->
			<section id="categories" class="aside">
				<h2>Constraints</h2>
			</section>
		
			<!-- BEGIN TECH OPTIONS (right side): change dynamically based on user selected constraints -->
			<section class="asideoffset">
				<section id="userselected"></section> <!-- USER SELECTED CONSTRAINTS -->
				<fieldset id="tech"><legend class="h2">&nbsp;My Tech Options <small id="counter"></small>&nbsp;</legend></fieldset>
			</section>
		
		
		</section>
		<!-- END second row of content -->
		


	</section>
	<!-- ************ END PAGE CONTENT ************ -->
	

	<footer class="border">
		<!-- potentially add (c) info, etc. -->
	</footer>

	<!-- DROPDOWN UI, needs to remain immediately before </body> tag -->
	<div id="dropdown-1" class="dropdown dropdown-tip">
		<ul class="dropdown-menu">
			<li><img id="phoneMsg" class="selected drop" src="img/phone.png" width="200px"></li>
			<li><img id="computerMsg" class="deselected drop" src="img/computer.png" width="200px"></li>
			<li><img id="bothMsg" class="deselected drop" src="img/both.png" width="200px"></li>
		</ul>
	</div>	
	
</body>
</html>